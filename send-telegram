#!/bin/bash

# Usage: ./send-telegram "message text" [mention]
# Sends a message to a Telegram chat
# Add "mention" as second parameter to include mentions

if [ $# -lt 1 ] || [ $# -gt 2 ]; then
    echo "Usage: $0 \"message text\" [mention]"
    echo "Add 'mention' as second parameter to include mentions"
    exit 1
fi

if [ -z "$TELEGRAM_BOT_TOKEN" ]; then
    echo "TELEGRAM_BOT_TOKEN is not set!"
    exit 1
fi

if [ -z "$TELEGRAM_CHAT_ID" ]; then
    echo "TELEGRAM_CHAT_ID is not set!"
    exit 1
fi

MESSAGE="$1"
INCLUDE_MENTIONS="$2"

# Use message as-is
FORMATTED_MESSAGE="${MESSAGE}"

# Add mentions if configured and requested
if [ "$INCLUDE_MENTIONS" = "mention" ] && [ ! -z "$TELEGRAM_MENTIONS" ]; then
    FORMATTED_MESSAGE="${FORMATTED_MESSAGE}

${TELEGRAM_MENTIONS}"
fi

# Send message to Telegram
curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
    -d chat_id="${TELEGRAM_CHAT_ID}" \
    -d text="${FORMATTED_MESSAGE}" \
    > /dev/null

if [ $? -eq 0 ]; then
    echo "Telegram notification sent successfully"
else
    echo "Failed to send Telegram notification"
    exit 1
fi